---
description: Twigs Mobile - project-specific conventions for the React Native component library
alwaysApply: true
---

# Twigs Mobile

React Native component library for SurveySparrow.

**Web counterpart:** [@sparrowengg/twigs-react](https://github.com/surveysparrow/twigs) — always validate component implementations against the web library (see `web-library-reference.mdc`).

## Repo Structure

- `src/` - Source components. One folder per component.
- `lib/` - Build output generated by `react-native-builder-bob` (run `yarn build`). **Never edit files in `lib/` directly.**
- `docs/` - Architecture, convention documentation, and per-component API docs.
  - `docs/components/<name>.md` - One doc file per component (created by the `create` command).
- `example/` - Expo SDK 52 example app with Storybook for interactive component browsing.
- `.rnstorybook/` - Storybook configuration (main, preview, entry point).
- `src/index.ts` - Root barrel file that re-exports every public component and type.
- `babel.config.js` - Babel config; must include `react-native-reanimated/plugin` as the **last** plugin.

Only the compiled `lib/` directory ships to npm. Raw TypeScript source is not published.

## Component Folder Layout

Follows the **react-native-paper convention**: role-based file names, flat structure for
simple components, sub-folders only when a sub-component itself becomes complex.

### Small component (< ~250 LOC) -- 4 files

```
src/<name>/
  index.ts              # barrel re-exports (the public API for this component)
  types.ts              # props interface + type aliases
  <name>.tsx            # component implementation
  <name>.stories.tsx    # Storybook story with interactive controls
```

### Medium component (~250-500 LOC) -- add helpers / constants

```
src/<name>/
  index.ts              # barrel re-exports
  types.ts              # props interface + type aliases
  <name>.tsx            # main component (composition + rendering only)
  <name>.stories.tsx    # Storybook story with interactive controls
  constants.ts          # size maps, dimension configs, magic numbers, enums
  helpers.ts            # pure functions: getColorStyles(), getSizeStyles(), etc.
  styles.ts             # static StyleSheet.create({...})
```

### Large / compound component (500+ LOC, multiple visual parts)

```
src/<name>/
  index.ts              # barrel re-exports
  types.ts              # shared props, interfaces, type aliases
  <name>.tsx            # main component (thin orchestrator)
  <name>.stories.tsx    # Storybook story with interactive controls
  constants.ts          # size maps, config objects
  helpers.ts            # pure style / logic functions
  styles.ts             # static StyleSheet.create({...})
  <sub-component>.tsx   # extracted visual sub-component (e.g. line-loader.tsx)
  <variant>.tsx         # variant-specific rendering (e.g. text-input-flat.tsx)
  <SubFeature>/         # sub-folder ONLY when a sub-component has its own types/helpers
    index.ts
    types.ts
    <sub-feature>.tsx
```

### When to split -- decision guide

| Signal | Action |
|---|---|
| File exceeds ~250 LOC | Extract `constants.ts` and `helpers.ts` |
| Static `StyleSheet.create` > 30 lines | Move to `styles.ts` |
| A sub-component has its own props interface + helpers | Give it a sub-folder |
| Multiple visual variants (e.g. outlined vs filled) | One `<variant>.tsx` per variant |
| Config objects (size maps, color maps) are reused by multiple functions | Put in `constants.ts` |

### File naming rules

- **Role-based names** -- `types.ts`, `constants.ts`, `helpers.ts`, `styles.ts` (not `style-helpers.ts`, `size-config.ts`, etc.)
- **Sub-component files** -- named after the sub-component in kebab-case: `line-loader.tsx`, `button-icon.tsx`
- **Variant files** -- named after the variant: `text-input-flat.tsx`, `text-input-outlined.tsx`

### Barrel `index.ts` rules

The barrel `index.ts` is the **single source of truth** for what is publicly exported.
- Only re-export public components and their types.
- Never re-export internal helpers, constants, or styles.
- Consumers must never import from files other than `index.ts`.

## Component Implementation Rules

### forwardRef + displayName (required for all public components)

```tsx
import React from 'react';
import { Pressable, StyleSheet, View } from 'react-native';
import { useTheme } from '../context';
import type { ComponentProps } from './types';

const styles = StyleSheet.create({
  base: { /* static styles */ },
  disabled: { opacity: 0.5 },
});

export const Component = React.forwardRef<View, ComponentProps>(
  ({ size = 'md', disabled = false, css, style, ...rest }, ref) => {
    const theme = useTheme();
    return (
      <Pressable
        ref={ref}
        style={[styles.base, disabled && styles.disabled, css, style]}
        {...rest}
      />
    );
  }
);
Component.displayName = 'Component';
```

### Props interface pattern

- Define props in `types.ts`, not in the component file.
- Always extend `CommonStyleProps` (from `../utils`) to provide `css` and `style` prop support.
- Extend the relevant React Native base props (`PressableProps`, `ViewProps`, `TextInputProps`, etc.).
- Use `interface` (not `type`) for props.

```tsx
import type { PressableProps } from 'react-native';
import type { CommonStyleProps } from '../utils';

export interface ButtonProps extends PressableProps, CommonStyleProps {
  size?: ButtonSize;
  color?: ButtonColor;
  variant?: ButtonVariant;
  disabled?: boolean;
  loading?: boolean;
}
```

### Internal sub-components / helpers

Internal sub-components that are **not** exported from `index.ts` may use `React.FC` (no `forwardRef` needed) or plain function components.

## Theme System

### Always use `useTheme()` for colors and typography

```tsx
const theme = useTheme();
// Good
backgroundColor: theme.colors.primary500
fontFamily: theme.fonts.bold

// Bad - never hardcode hex values
backgroundColor: '#00828D'
```

### No hardcoded colors policy

- All colors must come from `useTheme()` (e.g. `theme.colors.primary500`).
- For alpha/opacity variants, use the shared `colorOpacity()` helper from `../utils` instead of writing `#RRGGBBAA` hex literals.

```tsx
// Good
import { colorOpacity } from '../utils';
const pressedBg = colorOpacity(theme.colors.primary500, 0.1);

// Bad
const pressedBg = '#00828D1A';
```

### Token types

All dimension tokens are React Native dp numbers, not CSS strings.

| Token | Type | Example |
|---|---|---|
| `colors` | `string` (hex) | `'#00828D'` |
| `space` | `number` (dp) | `8` |
| `fontSizes` | `number` (dp) | `14` |
| `lineHeights` | `number` (dp) | `20` |
| `sizes` | `number` (dp) | `16` |
| `borderWidths` | `number` (dp) | `1` |
| `radii` | `number` (dp) | `8`; `round`/`pill` use `9999` |
| `transitions` | `number` (ms) | `200` |
| `fontWeights` | `string` | `'400'` (RN expects string) |
| `fonts` | `string` | `'System'` |

Use `createTextStyle(fontFamily, fontWeight)` from `../utils` to build platform-safe text styles.

## Animations

Use `react-native-reanimated` for all animations. Import the `AnimatedView` wrapper from `../utils`:

```tsx
import { AnimatedView } from '../utils';
import { useAnimatedStyle, useSharedValue, withTiming } from 'react-native-reanimated';
```

Do **not** use the React Native `Animated` API directly.

## Build Configuration

### react-native-builder-bob

The library is compiled by `react-native-builder-bob`. Key config in `package.json`:

```json
"react-native-builder-bob": {
  "source": "src",
  "output": "lib",
  "targets": [
    ["commonjs", { "configFile": true }],
    ["module", { "configFile": true }],
    "typescript"
  ],
  "exclude": ["**/{__tests__,__fixtures__,__mocks__}/**", "**/*.stories.{ts,tsx}"]
}
```

- **`configFile: true`** on `commonjs` and `module` targets tells bob to use the project's `babel.config.js` instead of its built-in preset. This is required so the Reanimated Babel plugin processes worklets during compilation.
- **`exclude`** prevents test and story files from being compiled into `lib/`.

### babel.config.js

Must include `react-native-reanimated/plugin` as the **last** entry in the plugins array:

```js
module.exports = {
  presets: ['module:@react-native/babel-preset'],
  plugins: ['react-native-reanimated/plugin'],
};
```

### tsconfig.json excludes

Ensure `tsconfig.json` excludes test and story files to prevent declaration files leaking into `lib/typescript/`:

```json
"exclude": ["lib", "example", "src/__tests__", "**/*.stories.ts", "**/*.stories.tsx"]
```

## Storybook

### Overview

Components have co-located Storybook stories using `@storybook/react-native`. The example app at `example/` renders the Storybook UI for on-device browsing.

### Story file conventions

- **Location**: `src/<name>/<name>.stories.tsx` (co-located with the component)
- **Format**: CSF3 (`Meta`, `StoryObj` from `@storybook/react`)
- **Controls**: Every public prop gets an `argType` with an appropriate control (`select`, `boolean`, `text`, `color`, `number`)
- **Stories**: Include Default, each size variant, each visual variant, disabled state

### Configuration

- `.rnstorybook/main.ts` — configures story globs (`../../src/**/*.stories.@(ts|tsx)`)
- `.rnstorybook/preview.tsx` — global decorators (`GestureHandlerRootView`, `TwigsProvider`)
- `.rnstorybook/index.tsx` — Storybook UI entry point

### Build exclusion

Story files are excluded from the library build:
- `react-native-builder-bob` `exclude` config prevents compilation
- `tsconfig.json` `exclude` prevents declaration generation
- `package.json` `files` field ensures they don't ship to npm

## Accessibility

Aligned with the [React Native Accessibility API](https://reactnative.dev/docs/accessibility) and the web twigs library's Radix-powered accessibility.

### Shared `BaseAccessibilityProps` interface

All component prop interfaces extend `BaseAccessibilityProps` (from `../utils`), which provides:
- `accessible`, `accessibilityRole`, `accessibilityLabel`, `accessibilityHint`
- `accessibilityState` (disabled, selected, checked, busy, expanded)
- `accessibilityValue` (min, max, now, text)
- Platform-specific: `accessibilityViewIsModal` (iOS), `accessibilityLiveRegion` (Android), `importantForAccessibility` (Android), etc.

### Interactive component requirements

Every interactive component must ship with these baseline attributes:

| Component | `accessibilityRole` | `accessibilityState` | Additional |
|-----------|--------------------|--------------------|-----------|
| Button | `"button"` | `{ disabled, busy: loading }` | `accessible={true}`, auto-derives `accessibilityLabel` for icon-only buttons |
| Switch | `"switch"` | `{ checked: value, disabled }` | `accessibilityValue={{ text: 'On'/'Off' }}` |
| Checkbox | `"checkbox"` | `{ checked, disabled }` (checked="mixed" for indeterminate) | `accessibilityLabel` from children text, `accessibilityHint` |
| Radio | `"radio"` | `{ checked: selected, disabled }` | `accessibilityLabel` from children text, `accessibilityHint` |
| TextInput | N/A (native) | `{ disabled }` on the `RNTextInput` | `accessibilityLabel` derived from placeholder, password toggle has `accessibilityRole="button"` |

### Display component requirements

| Component | `accessibilityRole` | Notes |
|-----------|--------------------|----|
| Avatar | `"image"` | `accessibilityLabel={name}`, `accessibilityIgnoresInvertColors` on Image |
| Text | pass-through | Forwards all a11y props to underlying `RNText` |
| Box / Flex | pass-through | Forwards all a11y props to underlying `View` |

### Error messages

Error/validation messages must use:
```tsx
<View accessibilityRole="alert" accessibilityLiveRegion="polite">
  <Text>{errorMessage}</Text>
</View>
```

### Key rules

- **Never use `selected` for radio/checkbox** — use `checked` in `accessibilityState` (matching Radix's `aria-checked`).
- **Icon-only buttons must have an `accessibilityLabel`** — auto-derived as "Button" if not explicitly provided.
- **Password toggle buttons** need `accessibilityRole="button"` and contextual labels ("Show password" / "Hide password").
- All primitive components (`Box`, `Flex`, `Text`) must forward a11y props to the underlying RN element.

## Testing

Run tests with `yarn test` (or `yarn test:watch` for watch mode).

### Stack

- **Jest** with `react-native` preset and `ts-jest` for TypeScript transforms
- **@testing-library/react-native** for component rendering and queries
- Mocks for `react-native-reanimated` and `react-native-svg` in `src/__tests__/__mocks__/`

### File placement

All test files go in `src/__tests__/` and use the naming convention `<component>.test.tsx` (or `.test.ts` for pure unit tests).

### TwigsProvider wrapper

Components that use `useTheme()` must be wrapped in `TwigsProvider` during tests:

```tsx
import { render } from '@testing-library/react-native';
import { TwigsProvider } from '../context';

const wrap = (ui: React.ReactElement) =>
  render(<TwigsProvider>{ui}</TwigsProvider>);
```

Primitive components (`Box`, `Flex`) that don't consume theme can be rendered directly with `render()`.

### Fix the code, don't adjust the test

When a test fails, **always investigate the component first** before changing the test expectation. A failing test often reveals a real bug (e.g. edge-case handling, missing prop forwarding, incorrect logic). Only adjust the test if the expectation itself was genuinely wrong.

### Test coverage per component

Each component test file should cover five areas:

1. **Render** — component mounts without crashing, renders expected content
2. **Variants** — all size, color, and style variant props render correctly
3. **Accessibility** — validates `accessibilityRole`, `accessibilityState`, `accessibilityLabel`, `accessibilityHint`
4. **Interaction** — `fireEvent.press` triggers callbacks, disabled/loading prevents calls
5. **State transitions** — use `rerender` to verify prop changes update a11y attributes and output

## Exports

- Every public component and its props type must be exported from `src/<name>/index.ts`.
- The root `src/index.ts` must re-export everything that consumers need.
- Use named exports only; no default exports.
- Always export types with `export type { ... }` syntax.

## Component Documentation

Every public component must have a documentation file:

- **Location**: `docs/components/<dir-name>.md`
- **Template**: Copy from `docs/component-template.md` and fill in all sections.
- **Required sections**: Props table, Variants, Usage example, Accessibility notes, Mobile Deviations from Web.
- **Getting Started**: Update the component table in `docs/getting-started.md` with a new row when adding a component.

The `create` skill auto-generates docs. When modifying a component, update its doc file.

## Sub-Agent Patterns

When performing complex multi-step tasks (like creating a new component), use
the Task tool to split work across sub-agents. See `component-commands.mdc` for
the full sub-agent strategy.

Key rules:
- `explore` agents for readonly discovery and analysis (web source fetching, pattern analysis).
- `generalPurpose` agents for independent file creation (tests, docs).
- `shell` agents for running commands (lint, test, build).
- Main agent for implementation and user interaction (file dependencies, feasibility checks).
- Never launch more than 2 sub-agents simultaneously.
- Always pass full context in the prompt — sub-agents have no conversation access.
